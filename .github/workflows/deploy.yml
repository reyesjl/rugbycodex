name: Deploy RugbyCodex

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Node & pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 9.0.0
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build frontend
      run: pnpm build

    # ---- FIXED TIMESTAMP ----
    - name: Set release timestamp
      run: echo "RELEASE=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

    - name: Deploy via rsync over SSH
      uses: burnett01/rsync-deployments@v1.3
      with:
        switches: "-avz --delete"
        path: "dist/"
        remote_path: "/var/www/rugbycodex/releases/release_${{ env.RELEASE }}/"
        remote_host: "96.126.118.201"
        remote_user: "deploy"
        ssh_private_key: ${{ secrets.SSH_RUGBYCODEX }}

    - name: Activate release and prune old ones
      run: |
        echo "${{ secrets.SSH_RUGBYCODEX }}" > key.pem
        chmod 600 key.pem

        ssh -o StrictHostKeyChecking=no -i key.pem deploy@96.126.118.201 "
          BASE=/var/www/rugbycodex
          NEWREL=\$BASE/releases/release_${{ env.RELEASE }}
          ln -sfn \$NEWREL \$BASE/current

          cd \$BASE/releases
          ls -1dt release_* | tail -n +6 | xargs rm -rf --

          echo 'Active release:'
          readlink -f \$BASE/current

          echo 'Remaining releases:'
          ls -1dt release_*
        "

