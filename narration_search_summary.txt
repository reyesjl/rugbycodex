Narration Search Summary (current flow)

Scope
- Narrations are searchable by keyword and semantic similarity.
- Hybrid search combines full-text (tsvector) and vector similarity.
- The exact SQL for search_narrations_hybrid is not in this repo.

Data model (narrations)
- transcript_raw / transcript_clean: transcription text.
- transcript_tsv: tsvector generated from transcript_clean or transcript_raw.
- embedding: pgvector (1536 dims), generated by OpenAI.
- Indexing guidance in docs: IVFFLAT index on narrations.embedding with vector_cosine_ops.

Embedding generation (narration)
1) Frontend triggers generate-narration-embedding edge function with narrationId.
2) Edge function fetches narrations row and builds embedding using OpenAI
   (model: text-embedding-3-small, 1536 dims).
3) Edge function updates narrations.embedding (skips if already present unless forced).

Search request (frontend)
1) useNarrationSearch watches the search query and active org.
2) For a non-empty query, it requests a query embedding via
   narrationService.generateSearchEmbedding â†’ generate-query-embedding edge function.
3) It calls supabase.rpc('search_narrations_hybrid') with:
   - query_text: user query
   - query_embedding: OpenAI embedding for the query
   - match_count: default 20
   - org_id_filter: active org id
4) The composable maps RPC results to matching narration/segment ids and filters
   the current segment list for display.

Ranking formula (search_narrations_hybrid)
- Semantic candidates:
  - score = 1 - (embedding <=> query_embedding)  -- cosine distance converted to similarity
  - filter: score > 0.33
  - order by embedding <=> query_embedding
  - limit: match_count * 2
- Lexical candidates:
  - score = ts_rank(transcript_tsv, plainto_tsquery('simple', query_text))
  - filter: transcript_tsv @@ plainto_tsquery('simple', query_text)
  - order by score desc
  - limit: match_count * 2
- Combine semantic + lexical with UNION ALL, then:
  - group by narration id and take max(score)
  - order by score desc
  - limit match_count

Edge function: generate-query-embedding
- POST only, requires authenticated member role (x-org-id header).
- Uses OPENAI_API_KEY and returns the query embedding array.

Open items
-
